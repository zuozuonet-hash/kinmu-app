<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¤ã„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      margin: 24px; 
      background: #f6f8fa; 
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    h1 { text-align: center; color: #d32f2f; }
    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .warning h2 {
      margin-top: 0;
      color: #856404;
    }
    button { 
      margin: 10px 5px; 
      padding: 12px 24px; 
      font-size: 16px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
    }
    .delete-btn {
      background: #d32f2f;
      color: #fff;
    }
    .delete-btn:hover {
      background: #b71c1c;
    }
    .delete-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .cancel-btn {
      background: #757575;
      color: #fff;
    }
    .cancel-btn:hover {
      background: #616161;
    }
    .result { 
      margin-top: 20px; 
      padding: 15px; 
      border-radius: 6px; 
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
    }
    .result.info { background: #e3f2fd; color: #0d47a1; }
    .result.success { background: #c8e6c9; color: #2e7d32; }
    .result.error { background: #ffcdd2; color: #c62828; }
    .button-group {
      text-align: center;
      margin: 30px 0;
    }
    .keep-list {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
    }
    .keep-list h3 {
      margin-top: 0;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <h1>âš ï¸ å¤ã„ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬å‰Šé™¤ãƒ„ãƒ¼ãƒ«</h1>

  <div class="warning">
    <h2>âš ï¸ è­¦å‘Š</h2>
    <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ <strong>winter-shifts</strong> ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å¤ã„ãƒ©ãƒ³ãƒ€ãƒ IDãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
    <p><strong>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼</strong></p>
  </div>

  <div class="keep-list">
    <h3>âœ… ä¿æŒã•ã‚Œã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</h3>
    <p>ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å‰Šé™¤ã•ã‚Œãšã€ä¿æŒã•ã‚Œã¾ã™ï¼š</p>
    <ul id="keepList">
      <li>Loading...</li>
    </ul>
  </div>

  <div class="button-group">
    <button class="delete-btn" id="deleteBtn">å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
    <button class="cancel-btn" onclick="window.location.href='index.html'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <div class="result info" id="result">å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã®ä¸€è¦§ã‚’ç¢ºèªã§ãã¾ã™ã€‚</div>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs,
      doc,
      deleteDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const deleteBtn = document.getElementById("deleteBtn");
    const resultEl = document.getElementById("result");
    const keepListEl = document.getElementById("keepList");

    const keepTeachers = new Set();

    async function loadKeepList() {
      try {
        const querySnapshot = await getDocs(collection(db, "winter-shifts"));
        const allDocs = [];
        
        querySnapshot.forEach((doc) => {
          const id = doc.id;
          if (!isRandomId(id)) {
            keepTeachers.add(id);
          }
          allDocs.push(id);
        });

        if (keepTeachers.size > 0) {
          keepListEl.innerHTML = Array.from(keepTeachers)
            .map(name => `<li><strong>${name}</strong></li>`)
            .join('');
        } else {
          keepListEl.innerHTML = '<li>ï¼ˆä¿æŒã™ã‚‹è·å“¡åãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</li>';
        }

        console.log("âœ… ä¿æŒã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:", Array.from(keepTeachers));
        console.log("ğŸ“‹ å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°:", allDocs.length);
      } catch (err) {
        console.error("âŒ ã‚¨ãƒ©ãƒ¼:", err);
        keepListEl.innerHTML = '<li style="color: red;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</li>';
      }
    }

    function isRandomId(id) {
      return /^[a-zA-Z0-9]{15,}$/.test(id);
    }

    loadKeepList();

    deleteBtn.addEventListener("click", async () => {
      if (!confirm("æœ¬å½“ã«å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼")) {
        return;
      }

      try {
        deleteBtn.disabled = true;
        resultEl.textContent = "å‰Šé™¤ä¸­...";
        resultEl.className = "result info";

        const querySnapshot = await getDocs(collection(db, "winter-shifts"));
        const toDelete = [];
        const toKeep = [];

        querySnapshot.forEach((docSnap) => {
          const id = docSnap.id;
          if (isRandomId(id)) {
            toDelete.push(id);
          } else {
            toKeep.push(id);
          }
        });

        console.log("ğŸ—‘ï¸ å‰Šé™¤å¯¾è±¡:", toDelete.length, "ä»¶");
        console.log("âœ… ä¿æŒå¯¾è±¡:", toKeep.length, "ä»¶");

        if (toDelete.length === 0) {
          resultEl.textContent = "å‰Šé™¤ã™ã‚‹å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          resultEl.className = "result info";
          deleteBtn.disabled = false;
          return;
        }

        let deleted = 0;
        let failed = 0;
        const errors = [];

        for (const id of toDelete) {
          try {
            await deleteDoc(doc(db, "winter-shifts", id));
            deleted++;
            console.log(`âœ… å‰Šé™¤: ${id}`);
          } catch (err) {
            failed++;
            errors.push(`${id}: ${err.message}`);
            console.error(`âŒ å‰Šé™¤å¤±æ•—: ${id}`, err);
          }
        }

        let message = `âœ… å‰Šé™¤å®Œäº†ï¼\n\n`;
        message += `å‰Šé™¤ä»¶æ•°: ${deleted}ä»¶\n`;
        message += `ä¿æŒä»¶æ•°: ${toKeep.length}ä»¶\n`;
        
        if (toKeep.length > 0) {
          message += `\nä¿æŒã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:\n`;
          toKeep.forEach(name => {
            message += `  - ${name}\n`;
          });
        }

        if (failed > 0) {
          message += `\nâš ï¸ å‰Šé™¤å¤±æ•—: ${failed}ä»¶\n`;
          message += errors.join('\n');
          resultEl.className = "result error";
        } else {
          resultEl.className = "result success";
        }

        resultEl.textContent = message;
        
        await loadKeepList();

      } catch (err) {
        console.error("âŒ ã‚¨ãƒ©ãƒ¼:", err);
        resultEl.textContent = `å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`;
        resultEl.className = "result error";
      } finally {
        deleteBtn.disabled = false;
      }
    });
  </script>
</body>
</html>